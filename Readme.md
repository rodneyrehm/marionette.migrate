# Marionette.Migrate

Migrate your Backbone.Marionette based code from Marionette version `1.x` to `2.x`. Marionette.Migrate detects and (for development purposes) restores APIs and features that have been changed in Backbone.Marionette as of version 2.0.


## What is this? Why does this exist?

Upgrading Marionette is a problem because so much has changed in [version 2](https://github.com/marionettejs/backbone.marionette/releases/tag/v2.0.0), see [Marionette.Upgrade](https://github.com/marionettejs/Marionette.Upgrade) to get a feeling. The simple text based (context-free) search and replace offered by Marionette.Upgrade did not help much in our case. I tried walking our codebase and gave up after about 3 hours. The tool was a pain to use (not much context to go on, no change history, …).

Without context, a simple regular expression based approach is simply not able to distinguish between the old `View.prototype.close` now being `View.prototype.destroy` and `Region.prototype.close` now being `Region.prototype.empty` - let alone figure out that virtually every other library I'm using has a `close()` method as well. That's why the provided Upgrade tool - a python-based regular expression beast - did not help *at all*. Also, as I later discovered, that `upgrade.py` has some pretty weird rules in it - some of them annotated in my `mapping.js`.

Not believing I was the only one with this problem, I kept searching. The [Marionette.Migrate](https://github.com/ccamarat/Marionette.Migrate) plugin reverts some of the deprecations and prints warnings to the browser's console. It hasn't been updated in 5 months, no issues have been reported, and it completely lacks events. Obviously not going to help anyone either…

That left me with one of three conclusions:

* I'm taking this stuff way too seriously.
* Nobody is upgrading existing projects to Marionette v2.0.x.
* Nobody is using Marionette.
* I'm not only bad at Math, but also suck at computers, possibly even breathing.

Anyway, that's when I decided to create Marionette.Migrate (yes, ignoring that the name was already taken) inspired by [jQuery's Migrate Plugin](https://github.com/jquery/jquery-migrate/). So I could - in good faith - hand off the task of actually upgrading our code base to someone else.

Here's the console output generated by default - of course you can customize it to your liking…

![Console Screenshot](https://raw.github.com/rodneyrehm/Marionette.Migrate/master/img/console.png)


## Caveats

By design this utility only works in projects running [`RequireJS`](http://requirejs.org/) and when executed in Google Chrome. As I wrote this utility first and foremost for the developers of my team, these limitations are not a problem. If you see that differently, fix it and send a pull request.


## API "Documentation"

```js
// to load Marionette.Migrate without customization,
// simply configure the paths accordingly:
require.config({
  paths: {
    // …

    // Marionette dependencies
    'underscore': 'bower_components/Marionette.Migrate/marionette/2.0.3/lib/underscore',
    'backbone': 'bower_components/Marionette.Migrate/marionette/2.0.3/lib/backbone',
    'backbone.babysitter': 'bower_components/Marionette.Migrate/marionette/2.0.3/lib/backbone.babysitter',
    'backbone.wreqr': 'bower_components/Marionette.Migrate/marionette/2.0.3/lib/backbone.wreqr',
    // paths loaded by Marionette.Migrate
    'backbone.marionette.orig': 'bower_components/Marionette.Migrate/marionette/2.0.3/lib/backbone.marionette',
    'log': 'bower_components/log/log',
    'stacktrace': 'bower_components/jserror/public/js/stacktrace',
    // internal paths, because RequireJS does something weird
    'backbone.marionette.migrate': 'bower_components/Marionette.Migrate/src/backbone.marionette.migrate',
    'backbone.marionette.migrate.mapping': 'bower_components/Marionette.Migrate/src/backbone.marionette.migrate.mapping',
    // expose the bridge as if it were Marionette itself
    'backbone.marionette': 'bower_components/Marionette.Migrate/src/engage-bridge',
  }
});
```

You can customize Marionette.Migrate's logging behavior at initialization:

```js
require(['backbone.marionette.migrate', 'backbone.marionette.orig'], function(migrate, Marionette) {
  // engage migration bridge with default config
  return migrate(Marionette);

  // or go custom with options:
  var options = {
    // callback to log migration issues
    callback: function(message, stack) {
      // handle the notification
      // message: string, marked up with log syntax: https://github.com/adamschwartz/log#features
      console.log(message);
      // stack: array of {name: 'my_initializer', file: 'script.js', line: '216', column: '32'}
      console.log("in file", stack[0].file);

      // return true to prevent Marionette.Migrate from logging itself
      return true;
    },
    // callback to filter stack traces, invoked just before options.callback()
    filter: function(stack) {
      return stack.slice(1);
    },
    // regular expression used to overwrite internal options.filter() implementation
    // useful to skip internal libraries like backbone, marionette, jquery, etc.
    // (use either options.filter or options.filterExpression)
    filterExpression: /\/((backbone\.(marionette\.)?)|jquery\.)js$/i,
  };
  return migrate(Marionette, options);

  // or prevent console logging completely:
  // messages will still be available in Marionette._migrationLog
  return migrate(Marionette, {
    callback: function() {
      return true;
    }
  });
});

```

All messages are collected and accessible to you at `Marionette._migrationLog` looking something like the following snippet. This can be used to aggregate all hits, remove duplicates, sort by file and line, and provide your developers a nicer "task list". Note that Marionette.Migrate itself does not yet provide such an utility (PRs welcome, though).

```js
[
  {
    'message': '_Marionette.Region_: the method [c="color:red"]open[c] was renamed to [c="color:blue"]attachHtml[c] - both have been updated',
    'trace': [
      {
        'name': 'my_initializer',
        'file': 'script.js',
        'line': '216',
        'column': '32'
      },
      // …
    ]
  },
  // …
]
```


## Possible TODOs

Look at backward-filling the following, if someone complains:

* [Region] Calling show on a region with the same view that is currently shown is now a noop. Previously the view would be re-rendered. You can force a rerender by passing forceShow: true with the region show options. `MyApp.mainRegion.show(myView, {forceShow: true});`
* [View] API change: Returning false from onBeforeClose no longer prevents the view from closing. This behavior was inconsistent with the rest of the library, and would require far too much logic to respect in all cases. Instead of returning false, you should handle your logic before calling close on the view.
* [View] API change: childEvents callbacks no longer receives the event name as the first argument, making the arguments of those callbacks consistent with standard trigger callbacks.


## Changelog

### v0.1.0 (September 23rd 2014) ###

* initial release


## License

Marionette.Migrate is published under the [MIT License](http://opensource.org/licenses/mit-license).
